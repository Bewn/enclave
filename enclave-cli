#!/usr/bin/env sh
#
#
#
ENCLAVE_FILE="encl.rnd"  #~*~*~*# enclave random. disordered // aranged
ENCLAVE_LOOP="$l(sudo losetup -f)"

echo "~****~**~~*~*~*~*~**~**~*~*~****~*~*~*~*~***~*~*~***~*~*~***~**~*~*~****~*~*~*~*~***~*~*~*~**~*~*~**"
help () {
	echo "		This is the enclave cli help panel
			usage:
				 enclave-cli [ command ]
				 enclave-cli [ -o | --OPTION ][ <path_to_*.rnd> ]
				 
				 commands:
				   g, generate : to generate an enclave
				   c, config   : to edit, init, config, etc.				 
				 options:
				  -f, --file  FILE
				  -h, --help "
}

generate_rnd_file () {
	read -p "            desired size? 
                    enter e.g. '1' for 1*(2^10)^2 Bytes (=1MiB) or '4K' (=4000) for 4GiB
                    enter now: " input

			if [ ! -w $PWD ];
		  		then twd=$HOME ;
				else twd=$PWD
			fi
		  	rnd=$twd/$ENCLAVE_FILE
			echo "writing random (indeciferable) data to $twd/$ENCLAVE_FILE"
	dd if=/dev/urandom of=$rnd bs=1024 count="$input"x1024 status=progress
	echo "
			You have now created a raw random to-be-arranged enclave file
			hence it's name is jumbled but with inferred meaning."
}

add_to_lvm () {
	read -p "		
					would you like to add $USER to the logical volume management (lvm) group?
					if yes then you will only need to authenticate now and to decrypt the first time.
					[Y/n]" input
		case $input in 
			'Y'|'y'|'') sudo usermod -a -G lvm $USER 
						echo "added to lvm group" ;;
			'N'|'n') echo "dnot adding to lvm group" ;;
		esac
}

make_fs_on_rnd () {
	if [ ! -z $($1 | grep .rnd) ] ;
		then mkfs.btrfs $1 ;
	fi
}


activate_rnd_fs () {
	sudo bash -c "
	     losetup --direct-io=on $ENCLAVE_LOOP $ENCLAVE_FILE
	     cryptsetup open $ENCLAVE_LOOP --type=luks2 rnd
	     lvscan
	     "
}

setup_logical_volume () {
	if [ -z "$(sudo pvs)" ];
		 then sudo pvcreate /dev/mapper/rnd ;
	fi
	if [ -z "$(sudo vgs)" ];
		then sudo vgcreate rnd /dev/mapper/rnd ;
	fi
	if [ -z "$(sudo lvs)" ];
    		then sudo lvcreate -n benclave -l 100%FREE rnd ;
	fi
}

deactivate_enclave () {
   sudo bash -c "lvchange -an rnd
   		 cryptsetup close rnd
   		 losetup -D"
} 

config_procedure () {
	read -p "			 	configure? 

									[Y/n] " input
	case $input in
		y|Y|'') add_to_lvm ;;
		n|N) echo "not adding to lvm group, you will need sudo privileges to mount" ;;
	esac
}



#######~*~*~*~*~*~**~~*~**** "main" below *****~~~~*~*~*~*~*~*~*~*~*~*~*~

case $1 in
	'generate'|'g') generate_rnd_file ;;
	'config'|'c') config_procedure ;;
esac

echo "welcome to the enclave command-line interface!"
echo "~*~*~*~*~*~~*~*~*~ enjoy ~*~*~*~~*~*~*~*~*~*~*~"
PROMPT="encl-cli % <- "
read -p "$PROMPT" input

while true
do
	case $input in
		q|Q|quit|exit) exit 0 ;;
		c|C|config) config_procedure ;;
		h|H|help) help
	esac
	read -p "$PROMPT" input
done
